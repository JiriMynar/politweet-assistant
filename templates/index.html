{% extends "base.html" %}

{% block title %}Factchecker Asistent{% endblock %}

{% block head %}
<style>
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.875rem;
    }
    .badge-truth-1 { background-color: #16a34a; color: white; } /* Pravda */
    .badge-truth-2 { background-color: #4ade80; color: white; } /* Sp√≠≈°e pravda */
    .badge-truth-3 { background-color: #facc15; color: black; } /* Zav√°dƒõj√≠c√≠ */
    .badge-truth-4 { background-color: #f97316; color: white; } /* Sp√≠≈°e le≈æ */
    .badge-truth-5 { background-color: #dc2626; color: white; } /* Le≈æ */
</style>
{% endblock %}

{% block content %}
<!-- Hero sekce s call-to-action -->
<div class="bg-gradient-to-r from-blue-700 to-indigo-800 text-white rounded-xl shadow-xl mb-8 overflow-hidden">
    <div class="container mx-auto px-6 py-12 md:py-16">
        <div class="flex flex-col md:flex-row items-center">
            <div class="md:w-3/5 mb-8 md:mb-0 md:pr-8">
                <h1 class="text-3xl md:text-4xl font-bold mb-4 leading-tight">
                    Nenechte se oklamat dezinformacemi
                </h1>
                <p class="text-xl md:text-2xl mb-6 text-blue-100">
                    Ovƒõ≈ôte fakta v textech a obr√°zc√≠ch pomoc√≠ umƒõl√© inteligence bƒõhem nƒõkolika sekund.
                </p>
                <div class="flex flex-wrap gap-3 mb-6">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <span>Okam≈æit√© v√Ωsledky</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <span>Ovƒõ≈ôen√© zdroje</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <span>Detailn√≠ vysvƒõtlen√≠</span>
                    </div>
                </div>
                <a href="#factchecker" class="inline-block bg-white text-blue-800 font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-blue-50 transition-colors">
                    Zaƒç√≠t ovƒõ≈ôovat fakta
                </a>
            </div>
            <div class="md:w-2/5">
                <img src="https://images.unsplash.com/photo-1590856029826-c7a73142bbf1?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="Ovƒõ≈ôov√°n√≠ fakt≈Ø" class="rounded-lg shadow-lg">
            </div>
        </div>
    </div>
</div>

<div id="factchecker" class="max-w-4xl mx-auto" x-data="factChecker()">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        <h2 class="text-2xl md:text-3xl font-semibold text-gray-800 mb-6">Ovƒõ≈ôte fakta snadno a rychle</h2>
        
        <!-- Vstupn√≠ sekce -->
        <div class="space-y-6">
            <!-- Drop z√≥na pro obr√°zek -->
            <div 
                id="dropZone" 
                class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer transition-all"
                :class="{'border-blue-500 bg-blue-50': isDragging, 'has-image': hasImage}"
                @dragover.prevent="isDragging = true"
                @dragleave.prevent="isDragging = false"
                @drop.prevent="handleDrop"
                @click="document.getElementById('imageInput').click()"
                @paste="handlePaste"
                tabindex="0"
            >
                <template x-if="!hasImage">
                    <div class="space-y-2">
                        <div class="text-4xl">üñºÔ∏è</div>
                        <p class="text-gray-600">P≈ôet√°hni obr√°zek sem nebo klikni pro nahr√°n√≠</p>
                        <p class="text-sm text-blue-600">(M≈Ø≈æe≈° tak√© pou≈æ√≠t Ctrl+V pro vlo≈æen√≠ obr√°zku ze schr√°nky)</p>
                    </div>
                </template>
                <template x-if="hasImage">
                    <div class="relative">
                        <img id="preview" :src="imagePreview" class="max-h-64 mx-auto" alt="N√°hled obr√°zku">
                        <button 
                            @click.stop="clearImage" 
                            class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center"
                            title="Odstranit obr√°zek"
                        >√ó</button>
                    </div>
                </template>
                <input type="file" id="imageInput" class="hidden" accept="image/*" @change="handleImageSelect">
            </div>

            <!-- Textov√© pole -->
            <div>
                <label for="textInput" class="block text-sm font-medium text-gray-700 mb-1">Text k ovƒõ≈ôen√≠</label>
                <textarea 
                    id="textInput"
                    x-model="textInput" 
                    class="w-full border border-gray-300 rounded-lg p-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    rows="4" 
                    placeholder="Vlo≈æte text k ovƒõ≈ôen√≠ nebo dopl≈àte kontext k obr√°zku..."
                ></textarea>
            </div>

            <!-- Checkbox pro generov√°n√≠ odpovƒõdi pro soci√°ln√≠ s√≠tƒõ -->
            <div class="flex items-center">
                <input 
                    type="checkbox" 
                    id="generateSocial" 
                    x-model="generateSocial"
                    class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                >
                <label for="generateSocial" class="ml-2 text-gray-700">Vygenerovat i odpovƒõƒè pro soci√°ln√≠ s√≠tƒõ</label>
            </div>

            <!-- Tlaƒç√≠tko pro anal√Ωzu s popisem -->
            <div class="space-y-2">
                <button 
                    @click="analyze" 
                    class="w-full py-4 px-6 bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white text-lg font-medium rounded-lg shadow-md transition-all flex items-center justify-center"
                    :class="{'opacity-50 cursor-not-allowed': isAnalyzing || (!hasImage && !textInput.trim())}"
                    :disabled="isAnalyzing || (!hasImage && !textInput.trim())"
                >
                    <template x-if="!isAnalyzing">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            Ovƒõ≈ôit fakta
                        </div>
                    </template>
                    <template x-if="isAnalyzing">
                        <div class="flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Analyzuji...
                        </div>
                    </template>
                </button>
                <p class="text-sm text-gray-500 text-center">
                    Kliknut√≠m na tlaƒç√≠tko spust√≠te anal√Ωzu pomoc√≠ umƒõl√© inteligence, kter√° ovƒõ≈ô√≠ fakta v textu nebo na obr√°zku
                </p>
            </div>
        </div>

        <!-- V√Ωsledky anal√Ωzy -->
        <div x-show="analysisResult" x-cloak class="mt-8 border border-gray-200 rounded-lg p-6 bg-gray-50">
            <div class="mb-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-2">V√Ωsledek anal√Ωzy</h2>
                
                <!-- Badge s hodnocen√≠m -->
                <div class="mb-4" x-html="truthBadge"></div>
                
                <!-- Obsah anal√Ωzy -->
                <div class="prose max-w-none" x-html="formattedAnalysis"></div>
            </div>

            <!-- Sekce se zdroji -->
            <div x-show="sources.length > 0" class="mt-6 border-t border-gray-200 pt-4">
                <h3 class="text-lg font-medium text-gray-800 mb-2">Zdroje</h3>
                <ul class="list-disc pl-5 space-y-1">
                    <template x-for="source in sources" :key="source">
                        <li>
                            <a :href="source" target="_blank" class="text-blue-600 hover:underline break-all" x-text="source"></a>
                        </li>
                    </template>
                </ul>
            </div>

            <!-- Odpovƒõƒè pro soci√°ln√≠ s√≠tƒõ -->
            <div x-show="socialResponse" class="mt-6 border-t border-gray-200 pt-4">
                <h3 class="text-lg font-medium text-gray-800 mb-2">Odpovƒõƒè pro soci√°ln√≠ s√≠tƒõ</h3>
                <div class="bg-white border border-gray-300 rounded-lg p-4 relative">
                    <p x-text="socialResponse"></p>
                    <button 
                        @click="copyToClipboard(socialResponse)" 
                        class="absolute top-2 right-2 text-blue-600 hover:text-blue-800"
                        title="Kop√≠rovat do schr√°nky"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Tlaƒç√≠tka pro kop√≠rov√°n√≠ a sd√≠len√≠ -->
            <div class="mt-6 flex flex-wrap gap-3">
                <button 
                    @click="copyToClipboard(analysisResult)" 
                    class="flex items-center px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Kop√≠rovat celou anal√Ωzu
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sekce "Jak to funguje" -->
    <div class="mt-12 bg-white rounded-xl shadow-lg p-6 md:p-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Jak Factchecker Asistent funguje?</h2>
        
        <div class="grid md:grid-cols-3 gap-8">
            <div class="bg-blue-50 rounded-lg p-6 text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">1. Nahrajte obsah</h3>
                <p class="text-gray-600">Nahrajte obr√°zek nebo vlo≈æte text, kter√Ω chcete ovƒõ≈ôit. M≈Ø≈æete tak√© kombinovat oboj√≠ pro p≈ôesnƒõj≈°√≠ v√Ωsledky.</p>
            </div>
            
            <div class="bg-blue-50 rounded-lg p-6 text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">2. Umƒõl√° inteligence analyzuje</h3>
                <p class="text-gray-600">N√°≈° syst√©m vyu≈æ√≠v√° pokroƒçil√Ω model GPT-4o od OpenAI k anal√Ωze obsahu a ovƒõ≈ôen√≠ fakt≈Ø.</p>
            </div>
            
            <div class="bg-blue-50 rounded-lg p-6 text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">3. Z√≠skejte v√Ωsledky</h3>
                <p class="text-gray-600">Obdr≈æ√≠te detailn√≠ anal√Ωzu s hodnocen√≠m pravdivosti, vysvƒõtlen√≠m a odkazy na ovƒõ≈ôen√© zdroje.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function factChecker() {
        return {
            textInput: '',
            imageFile: null,
            imagePreview: null,
            hasImage: false,
            isDragging: false,
            isAnalyzing: false,
            generateSocial: false,
            analysisResult: null,
            socialResponse: null,
            
            // Zpracov√°n√≠ p≈ôeta≈æen√≠ obr√°zku
            handleDrop(event) {
                this.isDragging = false;
                const files = event.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    this.processImageFile(files[0]);
                }
            },
            
            // Zpracov√°n√≠ v√Ωbƒõru obr√°zku
            handleImageSelect(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    this.processImageFile(files[0]);
                }
            },
            
            // Zpracov√°n√≠ vlo≈æen√≠ obr√°zku pomoc√≠ Ctrl+V
            handlePaste(event) {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        this.processImageFile(file);
                        break;
                    }
                }
            },
            
            // Zpracov√°n√≠ souboru obr√°zku
            processImageFile(file) {
                this.imageFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.imagePreview = e.target.result;
                    this.hasImage = true;
                };
                reader.readAsDataURL(file);
            },
            
            // Vymaz√°n√≠ obr√°zku
            clearImage() {
                this.imageFile = null;
                this.imagePreview = null;
                this.hasImage = false;
                document.getElementById('imageInput').value = '';
            },
            
            // Anal√Ωza obsahu
            analyze() {
                if ((!this.hasImage && !this.textInput.trim()) || this.isAnalyzing) {
                    return;
                }
                
                this.isAnalyzing = true;
                this.analysisResult = null;
                this.socialResponse = null;
                
                const formData = new FormData();
                if (this.textInput.trim()) {
                    formData.append('text', this.textInput.trim());
                }
                if (this.imageFile) {
                    formData.append('image', this.imageFile);
                }
                formData.append('generate_social', this.generateSocial);
                
                fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Chyba p≈ôi anal√Ωze');
                    }
                    return response.json();
                })
                .then(data => {
                    this.analysisResult = data.analysis;
                    if (data.social) {
                        this.socialResponse = data.social;
                    }
                    
                    // Plynul√© p≈ôesunut√≠ na v√Ωsledky
                    setTimeout(() => {
                        const resultElement = document.querySelector('[x-show="analysisResult"]');
                        if (resultElement) {
                            resultElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 200);
                })
                .catch(error => {
                    alert('Nastala chyba: ' + error.message);
                })
                .finally(() => {
                    this.isAnalyzing = false;
                });
            },
            
            // Kop√≠rov√°n√≠ do schr√°nky
            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    // Zobrazen√≠ notifikace o √∫spƒõ≈°n√©m zkop√≠rov√°n√≠
                    const notification = document.createElement('div');
                    notification.className = 'notification';
                    notification.textContent = 'Zkop√≠rov√°no do schr√°nky';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.classList.add('show');
                    }, 10);
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 300);
                    }, 2000);
                });
            },
            
            // Form√°tovan√° anal√Ωza s odkazy
            get formattedAnalysis() {
                if (!this.analysisResult) return '';
                
                // Nahrazen√≠ odkaz≈Ø klikatelnou verz√≠
                let formatted = this.analysisResult
                    .replace(/Status: ([1-5]\. [^<\n]+)/g, '<span class="hidden">$1</span>') // Skryjeme status, proto≈æe ho zobrazujeme jako badge
                    .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-600 hover:underline break-all">$1</a>')
                    .replace(/\n/g, '<br>');
                
                return formatted;
            },
            
            // Badge s hodnocen√≠m pravdivosti
            get truthBadge() {
                if (!this.analysisResult) return '';
                
                const statusMatch = this.analysisResult.match(/Status: ([1-5]\. [^<\n]+)/);
                if (!statusMatch) return '';
                
                const status = statusMatch[1];
                let badgeClass = 'badge ';
                
                if (status.includes('1. Pravda')) {
                    badgeClass += 'badge-truth-1';
                } else if (status.includes('2. Sp√≠≈°e pravda')) {
                    badgeClass += 'badge-truth-2';
                } else if (status.includes('3. Zav√°dƒõj√≠c√≠')) {
                    badgeClass += 'badge-truth-3';
                } else if (status.includes('4. Sp√≠≈°e le≈æ')) {
                    badgeClass += 'badge-truth-4';
                } else if (status.includes('5. Le≈æ')) {
                    badgeClass += 'badge-truth-5';
                }
                
                return `<span class="${badgeClass}">${status}</span>`;
            },
            
            // Extrakce zdroj≈Ø z anal√Ωzy
            get sources() {
                if (!this.analysisResult) return [];
                
                const sourcesMatch = this.analysisResult.match(/Zdroje: ([\s\S]+)/);
                if (!sourcesMatch) return [];
                
                const sourcesText = sourcesMatch[1];
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const sources = [];
                let match;
                
                while ((match = urlRegex.exec(sourcesText)) !== null) {
                    sources.push(match[1]);
                }
                
                return sources;
            }
        };
    }
</script>
{% endblock %}
